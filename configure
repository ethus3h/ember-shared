#!/usr/bin/env bash
set -x

# Special configure for ember-shared.

packageName="$(cat package-name)"

#NOTE: MAINTENANCE: Manual error printing
trap 'printf '\''%b'\'' '\''\033[1;31m'\'' >&2; echo "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd)." >&2; printf '\''%b'\'' '\''\033[0m'\'' >&2; exit 1' ERR

rm -f support/.{prefix,mandir,infodir,datadir,sysconfdir,localstatedir}

currentArgPrefix=""
module=""
while [[ -n "$1" ]]; do
    currentArgPrefix="${1%%=*}"
    case $currentArgPrefix in
    --prefix)
        printf '%s' "${1#*=}" > support/.prefix
        ;;
    --mandir)
        printf '%s' "${1#*=}" > support/.mandir
        ;;
    --infodir)
        printf '%s' "${1#*=}" > support/.infodir
        ;;
    --datadir)
        printf '%s' "${1#*=}" > support/.datadir
        ;;
    --sysconfdir)
        printf '%s' "${1#*=}" > support/.sysconfdir
        ;;
    --localstatedir)
        printf '%s' "${1#*=}" > support/.localstatedir
        ;;
    --module)
        module="${1#*=}"
        ;;
    *)
        true
        ;;
    esac
    shift
done

echo "Success will be indicated by printing"' "Configuring complete".'
if [[ -z "$module" ]]; then
    echo "ERROR: Please specify a module to configure for. Options: error-notify, core, main, extra"
    exit 1
fi

if [[ -e "./.ember-build" ]]; then
    rm -rf "./.ember-build"
    true
fi
mkdir "./.ember-build"
originalGlobignore="$GLOBIGNORE"
GLOBIGNORE="./.:./..:./.ember-build:./.git"
cp -r ./* ./.ember-build/ || true
GLOBIGNORE="$originalGlobignore"
pushd ./.ember-build || exit 1

case $module in
error-notify)
    find scripts -type f -not -name 'error-notify' -print || exit 1
    mv support/error-notify.Makefile Makefile
    rm -r ./data ./support || exit 1
    ;;
core)
    printf '%s' "${1#*=}" > support/.mandir
    ;;
main)
    printf '%s' "${1#*=}" > support/.infodir
    ;;
extra)
    printf '%s' "${1#*=}" > support/.datadir
    ;;
*)
    true
    ;;
esac

if ! fmwtk_loc="$(type -P "futuramerlin-web-toolkit-build")" || [[ -z $fmwtk_loc ]]; then
    echo $'\n'"futuramerlin-web-toolkit not found: documentation will not be built."$'\n'
fi
echo "Configuring complete."
