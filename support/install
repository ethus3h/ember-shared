#!/usr/bin/env bash
#set -x

# Should work without ember-shared or crystallize, just in case, so don't set traps or source ember_bash_setup

trap 'printf '\''%b'\'' '\''\033[1;31m'\'' >&2; echo "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd)." >&2; printf '\''%b'\'' '\''\033[0m'\'' >&2; exit 1' ERR

# NOTE: MAINTENANCE: Inlined function from ember_bash_setup
setVariableToCommandOutput() {
    if [[ "$1" == "emSetVariableToCommandOutputVar" ]]; then
        return 1
    fi
    emSetVariableToCommandOutputVar="$1"
    shift
    save_traps="$(trap)"
    trap - ERR
    IFS= read -rd '' "$emSetVariableToCommandOutputVar" < <( "$@" )
    trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd) at $(emdate)."' ERR
    eval "$save_traps"
}

# NOTE: MAINTENANCE: Inlined function from ember_bash_setup
eescape() {
    (
        export eescapeString="$1"
        local temp
        # shellcheck disable=SC2016
        setVariableToCommandOutput temp bash -c 'perl -0777 -e '\''print(quotemeta($ENV{eescapeString}))'\'' | sed '\''s/\\$//'\'' | sed '\''s/\\\r/\r/'\'
        temp="${temp//$'\n'/'\n'}"
        printf "%s" "${temp//$'\r'/'\r'}"
    )
}

# NOTE: MAINTENANCE: Inlined function from ember_bash_setup
ereplace() {
    (
        # Perl returns 0 even if it can't find the file (without extra perl code), so test first.
        if [[ ! -e "$3" ]]; then
            die "The target file does not exist."
        fi
        setVariableToCommandOutput ereplaceFrom eescape "$1"
        export ereplaceFrom
        ereplaceTo="$2"
        export ereplaceTo
        perl -0777 -p -i -e 's/$ENV{ereplaceFrom}/$ENV{ereplaceTo}/g' "$3"
    )
}

skipConfigFile="false"
if [[ "$1" == "--skip-config-file" ]]; then
    skipConfigFile="true"
    shift
fi

echo 1 "$1" 2 "$2" 3 "$3" 4 "$4" 5 "$5" 6 "$6" 7 "$7" 8 "$8" 9 "$9"
if [[ -n "$1" ]]; then
    emberSharedDestdir="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedPrefix="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedCapPrefix="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedExecPrefix="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedBindir="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedDatarootdir="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedDatadir="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedSysconfdir="$1"
    shift
fi
if [[ -n "$1" ]]; then
    emberSharedSharedstatedir="$1"
    shift
fi
if ! [[ -n "$emberSharedPrefix" ]]; then
    if ! [[ -n "$emberSharedCapPrefix" ]]; then
        emberSharedPrefix="$emberSharedDestdir"/usr/local
    else
        emberSharedPrefix="$emberSharedCapPrefix"
    fi
fi
echo "emberSharedPrefix: $emberSharedPrefix"
if ! [[ -n "$emberSharedExecPrefix" ]]; then
    emberSharedExecPrefix="$emberSharedPrefix"
fi
echo "emberSharedExecPrefix: $emberSharedExecPrefix"
if ! [[ -n "$emberSharedBindir" ]]; then
    emberSharedBindir="$emberSharedExecPrefix"/bin
fi
echo "emberSharedBindir: $emberSharedBindir"
if ! [[ -n "$emberSharedDatarootdir" ]]; then
    emberSharedDatarootdir="$emberSharedPrefix"/share
fi
echo "emberSharedDatarootdir: $emberSharedDatarootdir"
if ! [[ -n "$emberSharedDatadir" ]]; then
    emberSharedDatadir="$emberSharedDatarootdir"
fi
echo "emberSharedDatadir: $emberSharedDatadir"
if ! [[ -n "$emberSharedSysconfdir" ]]; then
    emberSharedSysconfdir="$emberSharedPrefix"/etc
fi
echo "emberSharedSysconfdir: $emberSharedSysconfdir"
if ! [[ -n "$emberSharedSharedstatedir" ]]; then
    emberSharedSharedstatedir="$emberSharedPrefix"/var
fi
echo "emberSharedSharedstatedir: $emberSharedSharedstatedir"

mkdir -p "$emberSharedBindir"
chmod +x scripts/*
cp scripts/* "$emberSharedBindir/"
