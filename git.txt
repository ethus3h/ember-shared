#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null || { printf '%b' '\033[1;31m' >&2; echo "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd): The required dependency ember-shared could not be found (or ember_bash_setup could not be sourced for some other reason)." >&2; printf '%b' '\033[0m' >&2; exit 1; }
#set -x

eogup-single
mkdir -p ~/ember-auto-build-temp
if [[ -n "$1" ]]; then
    pn="$1"
else
    pn="$(<package-name)"
fi
cp package.scm.tpl ~/ember-auto-build-temp/"$pn".scm
(
    cd ~ || die
    mkdir -p ember-auto-build-temp
    git clone "https://github.com/ethus3h/$pn.git"
    cd "$pn" || die
    hash="$(guix hash -rx .)"
    cd .. || die
    ereplace "TEMPLATE-PLACEHOLDER-PACKAGENAME" "$pn" "$pn".scm
    ereplace "TEMPLATE-PLACEHOLDER-HASH" "$hash" "$pn".scm
    cd ~/guix || die
    cp
)
cp ~/ember-auto-build-temp/"$pn".scm ./."$pn".scm
eogup-single
